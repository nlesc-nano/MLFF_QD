name: Notify on Push to dev_z
on:
  push:
    branches: [dev_z]  # Later main

jobs:
  notify-push:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack (push to branch)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.MLFF_SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          short_sha="${GITHUB_SHA::7}"
          commit_message=$(jq -r '.head_commit.message // "No commit message"' "$GITHUB_EVENT_PATH")
          commit_message_single_line=$(printf "%s" "$commit_message" | tr '\n' ' ')

          commit_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          push_time=$(TZ="Europe/Madrid" date +"%Y-%m-%d %H:%M:%S %Z")

          payload=$(jq -n \
            --arg ref   "$GITHUB_REF_NAME" \
            --arg actor "$GITHUB_ACTOR" \
            --arg url   "$commit_url" \
            --arg sha   "$short_sha" \
            --arg msg   "$commit_message_single_line" \
            --arg time  "$push_time" \
            '{
              attachments: [{
                color: "good",
                mrkdwn_in: ["text"],
                text:
                  (":rocket: *New Push to Branch*: `"+$ref+"`"
                   + "\n:bust_in_silhouette: *Pushed by*: "+$actor
                   + "\n:link: *Commit*: <"+$url+"|`"+$sha+"`>"
                   + "\n:memo: *Message*: `"+$msg+"`"
                   + "\n:clock3: *Time*: "+$time)
              }]
            }')

          curl -sS -X POST -H 'Content-type: application/json' \
            --data "$payload" \
            "$SLACK_WEBHOOK_URL"
